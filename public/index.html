<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <title>抽卡練習所</title>
  </head>
  <body>
    <draw-card-app></draw-card-app>

    <script type="module">
      const RARITY_FULL_MAP = {
        1: "C",
        2: "U",
        3: "R",
        4: "RR",
        5: "RRR",
        6: "PR",
        7: "TR",
        8: "SR",
        9: "HR",
        10: "UR",
        11: "無標記",
        12: "K",
        13: "A",
        14: "AR",
        15: "SAR",
        16: "S",
        17: "SSR",
        18: "ACE",
      };

      class DrawCardApp extends HTMLElement {
        constructor() {
          super();
          const template = document.createElement("template");
          template.innerHTML = `
          <style>
            :host {
              display: block;
              background-color: #fff;
              font-family: "Microsoft JhengHei", sans-serif;
            }
            .app {
              max-width: 1200px;
              margin: 0 auto;
              padding: 20px;
              text-align: center;
            }
            h1 {
              margin: 20px 0 10px;
              font-size: 32px;
              color: #4b2e06;
            }
            .intro-text {
              font-size: 16px;
              color: #555;
              margin-bottom: 30px;
              line-height: 1.6;
            }
            .intro-text a {
              color: #007acc;
              text-decoration: none;
            }
            .intro-text a:hover {
              text-decoration: underline;
            }
            .slider-container {
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
              gap: 20px;
              margin-bottom: 20px;
            }
            .slider-group {
              display: flex;
              flex-direction: column;
              align-items: center;
              margin-bottom: 10px;
            }
            .slider-group label {
              margin-bottom: 5px;
            }
            input[type="range"] {
              width: 160px;
            }
            .btn-container {
              margin-bottom: 20px;
            }
            button {
              width: 150px;
              height: 50px;
              font-size: 18px;
              margin: 10px;
              border: none;
              border-radius: 8px;
              cursor: pointer;
              transition: 0.2s;
              box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
            }
            button:hover {
              transform: scale(1.05);
              box-shadow: 3px 3px 10px rgba(0,0,0,0.3);
            }
            #card-container {
              display: flex;
              flex-wrap: wrap;
              justify-content: center;
            }
            .card {
              width: 200px;
              aspect-ratio: 63 / 88;
              position: relative;
              perspective: 800px;
              margin: 10px;
              cursor: pointer;
            }
            .card-inner {
              width: 100%;
              height: 100%;
              position: absolute;
              top: 0; left: 0;
              transition: transform 1s;
              transform-style: preserve-3d;
            }
            .card.flipped .card-inner {
              transform: rotateY(180deg);
            }
            .card-face {
              position: absolute;
              top: 0; left: 0;
              width: 100%;
              height: 100%;
              backface-visibility: hidden;
              display: flex;
              justify-content: center;
              align-items: center;
              margin: 0;
              padding: 0;
              overflow: hidden;
            }
            .card-front {
              background: none;
            }
            .card-front img {
              width: 100%;
              height: 100%;
              object-fit: contain;
              object-position: center;
              display: block;
            }
            .card-back {
              transform: rotateY(180deg);
              background: #fff;
              display: flex;
              flex-direction: column;
            }
            .card-back img {
              width: 100%;
              height: 100%;
              object-fit: contain;
            }
            .rarity-text {
              position: absolute;
              bottom: 5px;
              left: 50%;
              transform: translateX(-50%);
              background-color: rgba(255,255,255,0.7);
              padding: 3px 8px;
              border-radius: 6px;
              font-weight: bold;
              font-size: 16px;
            }
          </style>

          <div class="app">
            <h1>抽卡練習所</h1>
            <p class="intro-text">
              抽卡練習所：給抽不到 SSR 的人一點慰藉（笑）<br />
              部落格連結：
              <a href="https://blog.walle4561.com/" target="_blank">https://blog.walle4561.com/</a>
            </p>
            <div id="sliderContainer" class="slider-container"></div>
            <div class="btn-container">
              <button id="drawOneBtn">抽 1 次</button>
              <button id="drawTenBtn">抽 10 次 (不重複)</button>
              <button id="randomProbBtn">隨機機率</button>
            </div>
            <div id="card-container"></div>
          </div>
          `;

          this.attachShadow({ mode: "open" });
          this.shadowRoot.appendChild(template.content.cloneNode(true));

          this.sliderContainer =
            this.shadowRoot.querySelector("#sliderContainer");
          this.cardContainer = this.shadowRoot.querySelector("#card-container");
          this.drawOneBtn = this.shadowRoot.querySelector("#drawOneBtn");
          this.drawTenBtn = this.shadowRoot.querySelector("#drawTenBtn");
          this.randomProbBtn = this.shadowRoot.querySelector("#randomProbBtn");

          this.cardData = {};
          this.rarityList = Object.entries(RARITY_FULL_MAP).map(
            ([key, rarityName]) => ({
              id: parseInt(key),
              name: rarityName,
              prob: 0,
              sliderEl: null,
              labelEl: null,
            }),
          );
        }

        connectedCallback() {
          fetch("./pokemon_cards.json")
            .then((res) => res.json())
            .then((data) => {
              this.cardData = data;
            })
            .catch((err) => {
              console.error("載入卡片資料失敗：", err);
              alert("載入卡片資料失敗，請確認檔案路徑和格式。");
            });

          this.createSliders();
          this.drawOneBtn.addEventListener("click", () => {
            this.clearCards();
            this.drawOne();
          });
          this.drawTenBtn.addEventListener("click", () => {
            this.clearCards();
            this.drawTen();
          });
          this.randomProbBtn.addEventListener("click", () => {
            this.randomizeProbabilities();
          });
        }

        createSliders() {
          this.rarityList.forEach((rarityObj) => {
            const group = document.createElement("div");
            group.classList.add("slider-group");

            const label = document.createElement("label");
            label.textContent = `${rarityObj.name}: `;
            const span = document.createElement("span");
            span.textContent = rarityObj.prob;
            label.appendChild(span);
            label.appendChild(document.createTextNode(" %"));

            const slider = document.createElement("input");
            slider.type = "range";
            slider.min = "0";
            slider.max = "100";
            slider.value = "0";
            slider.addEventListener("input", (e) => {
              let newValue = parseInt(e.target.value, 10);
              rarityObj.prob = newValue;
              span.textContent = newValue;
              this.handleSliderSum(rarityObj);
            });

            rarityObj.sliderEl = slider;
            rarityObj.labelEl = span;
            group.appendChild(label);
            group.appendChild(slider);
            this.sliderContainer.appendChild(group);
          });
        }

        handleSliderSum(changedObj) {
          let total = this.rarityList.reduce((sum, item) => sum + item.prob, 0);
          if (total > 100) {
            let diff = total - 100;
            changedObj.prob -= diff;
            if (changedObj.prob < 0) changedObj.prob = 0;
            changedObj.sliderEl.value = changedObj.prob;
            changedObj.labelEl.textContent = changedObj.prob;
          }
        }

        // 隨機產生機率前先篩選卡池中至少有 10 張的稀有度
        randomizeProbabilities() {
          // 過濾出卡池數量 >= 10 的稀有度
          const eligible = this.rarityList.filter((r) => {
            return this.cardData[r.name] && this.cardData[r.name].length >= 10;
          });
          if (eligible.length === 0) {
            alert("沒有任何卡池有足夠的卡可以抽 10 張！");
            return;
          }
          // 使用 eligible 的數量來切分 0~100
          const m = eligible.length;
          let cuts = [];
          for (let i = 0; i < m - 1; i++) {
            cuts.push(Math.floor(Math.random() * 101));
          }
          cuts.push(0);
          cuts.push(100);
          cuts.sort((a, b) => a - b);
          // 針對所有稀有度設定機率：符合條件者依照隨機分配，其他則歸 0
          this.rarityList.forEach((r) => {
            if (this.cardData[r.name] && this.cardData[r.name].length >= 10) {
              const index = eligible.indexOf(r);
              let prob = cuts[index + 1] - cuts[index];
              r.prob = prob;
              r.sliderEl.value = prob;
              r.labelEl.textContent = prob;
            } else {
              r.prob = 0;
              r.sliderEl.value = 0;
              r.labelEl.textContent = 0;
            }
          });
        }

        clearCards() {
          this.cardContainer.innerHTML = "";
        }

        drawOne() {
          const totalProb = this.rarityList.reduce((sum, r) => sum + r.prob, 0);
          if (totalProb <= 0) {
            alert("機率總和為 0，請先調整滑桿再抽卡！");
            return;
          }
          const rarityName = this.getRarityByProb();
          if (!rarityName) return;
          const cardPool = this.cardData[rarityName] || [];
          if (cardPool.length === 0) {
            alert(`「${rarityName}」卡池沒有卡或找不到，抽卡失敗！`);
            return;
          }
          const randomIndex = Math.floor(Math.random() * cardPool.length);
          const cardImageUrl = cardPool[randomIndex];
          this.createCard(rarityName, cardImageUrl);
        }

        drawTen() {
          const totalProb = this.rarityList.reduce((sum, r) => sum + r.prob, 0);
          if (totalProb <= 0) {
            alert("機率總和為 0，請先調整滑桿再抽卡！");
            return;
          }
          // 建立暫存資料，避免直接更動原始資料
          const tempData = JSON.parse(JSON.stringify(this.cardData));
          let emptyPoolAlertShown = false;
          for (let i = 0; i < 10; i++) {
            setTimeout(() => {
              const rarityName = this.getRarityByProb();
              if (!rarityName) return;
              const cardPool = tempData[rarityName];
              if (!cardPool || cardPool.length === 0) {
                if (!emptyPoolAlertShown) {
                  emptyPoolAlertShown = true;
                  alert(
                    `「${rarityName}」卡池已經沒有可抽的卡了，無法抽到第 ${i + 1} 張。`,
                  );
                }
                return;
              }
              const randomIndex = Math.floor(Math.random() * cardPool.length);
              const cardImageUrl = cardPool.splice(randomIndex, 1)[0];
              this.createCard(rarityName, cardImageUrl);
            }, i * 120);
          }
        }

        getRarityByProb() {
          const totalProb = this.rarityList.reduce((sum, r) => sum + r.prob, 0);
          if (totalProb <= 0) return null;
          const rand = Math.floor(Math.random() * totalProb) + 1;
          let cumulative = 0;
          for (const r of this.rarityList) {
            cumulative += r.prob;
            if (rand <= cumulative) return r.name;
          }
          return null;
        }

        createCard(rarityName, cardImageUrl) {
          const card = document.createElement("div");
          card.classList.add("card");

          const cardInner = document.createElement("div");
          cardInner.classList.add("card-inner");

          const cardFront = document.createElement("div");
          cardFront.classList.add("card-face", "card-front");
          const frontImg = document.createElement("img");
          frontImg.src = "./card_back_img.png";
          frontImg.alt = "Card Back";
          cardFront.appendChild(frontImg);

          const cardBack = document.createElement("div");
          cardBack.classList.add("card-face", "card-back");
          const backImg = document.createElement("img");
          backImg.src = cardImageUrl;
          backImg.alt = `${rarityName} Card`;

          const rarityText = document.createElement("div");
          rarityText.classList.add("rarity-text");
          rarityText.textContent = rarityName;

          cardBack.appendChild(backImg);
          cardBack.appendChild(rarityText);

          cardInner.appendChild(cardFront);
          cardInner.appendChild(cardBack);
          card.appendChild(cardInner);

          card.addEventListener("click", () => {
            card.classList.toggle("flipped");
          });

          this.cardContainer.appendChild(card);
        }
      }

      customElements.define("draw-card-app", DrawCardApp);
    </script>
  </body>
</html>
